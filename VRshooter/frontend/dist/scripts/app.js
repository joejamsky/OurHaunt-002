import*as THREE from"./three.module.js";import{DeviceOrientationControls}from"./DeviceOrientationControls.js";let camera,scene,renderer,controls,raycaster,pointerPosition,sceneCubes,cubesDestroyed,currentLat,currentLon,startLat,startLon,positions;positions=[],sceneCubes=[],cubesDestroyed=0;const startButton=document.getElementById("startButton"),startLatDiv=document.getElementById("start-lat"),startLonDiv=document.getElementById("start-lon"),currentLatDiv=document.getElementById("current-lat"),currentLonDiv=document.getElementById("current-lon"),cameraXDiv=document.getElementById("camera-x"),cameraZDiv=document.getElementById("camera-z"),videoWidth=window.innerWidth,videoHeight=.7*window.innerHeight;function initLocation(){navigator.geolocation?(navigator.geolocation.getCurrentPosition(startPosition),navigator.geolocation.watchPosition(currentLocation)):console.error("Geolocation is not supported by this browser.")}function startPosition(e){startLat=e.coords.latitude,startLon=e.coords.longitude,startLatDiv.innerHTML="start lat "+startLat,startLonDiv.innerHTML="start lon "+startLon}function currentLocation(e){positions.push(e),positions.length>5&&positions.shift();var t=stabilizeCoordinates(positions);console.log("stablized coords",t),currentLat=t.latitude,currentLon=t.longitude,currentLatDiv.innerHTML="current Latitude: "+currentLat,currentLonDiv.innerHTML="current Longitude: "+currentLon}function stabilizeCoordinates(e){for(var t={latitude:0,longitude:0},n=0;n<e.length;n++)t.latitude+=e[n].coords.latitude,t.longitude+=e[n].coords.longitude;return console.log("coords lat",t.latitude),console.log("coords lon",t.longitude),t.latitude/=e.length,t.longitude/=e.length,t}function startVideo(){const e=document.getElementById("video");navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:{exact:"environment"}}}).then((t=>{e.srcObject=t,e.play()})).catch((e=>{console.error("Unable to access the camera.",e)}))}function openFullscreen(){var e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),screen.orientation.lock("landscape")}function handleTouch(e){pointerPosition.x=e.touches[0].clientX/videoWidth*2-1,pointerPosition.y=-e.touches[0].clientY/videoHeight*2+1}function generateSplitRandomClamped(){const e=Math.floor(19*Math.random())+-10;return e>=-1?e+(e>=0?2:-2):e}function addItemTimed(){if(sceneCubes.length<5){const e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial({color:65280}),n=new THREE.Mesh(e,t);let o=generateSplitRandomClamped(),i=THREE.MathUtils.randFloat(0,5),r=generateSplitRandomClamped();n.position.set(o,i,r),scene.add(n),sceneCubes.push(n.id),console.log("cubes",sceneCubes)}console.log("running")}function init(){camera=new THREE.PerspectiveCamera(75,videoWidth/videoHeight,1,1100),controls=new DeviceOrientationControls(camera),raycaster=new THREE.Raycaster,pointerPosition=new THREE.Vector2,scene=new THREE.Scene;const e=new THREE.SphereBufferGeometry(500,60,40);e.scale(-1,1,1);const t=new THREE.MeshBasicMaterial({map:(new THREE.TextureLoader).load("./src/textures/2294472375_24a3b8ef46_o.jpg")}),n=(new THREE.Mesh(e,t),new THREE.BoxBufferGeometry(100,100,100,4,4,4)),o=new THREE.MeshBasicMaterial({color:16711935,wireframe:!0}),i=new THREE.Mesh(n,o);scene.add(i),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(videoWidth,videoHeight),document.body.appendChild(renderer.domElement),window.addEventListener("resize",onWindowResize,!1),window.addEventListener("touchstart",handleTouch),window.setInterval((function(){addItemTimed()}),1e3)}function animate(){window.requestAnimationFrame(animate),controls.update(),raycaster.setFromCamera(pointerPosition,camera);const e=raycaster.intersectObjects(scene.children);camera.position.set(1e5*(startLon-currentLon),0,1e5*(startLat-currentLat)),cameraXDiv.innerHTML="camera x "+1e5*(startLat-currentLat),cameraZDiv.innerHTML="camera z "+1e5*(startLon-currentLon);for(let t=0;t<e.length;t++)if(sceneCubes.includes(e[t].object.id)){const n=sceneCubes.findIndex((n=>n==e[t].object.id));scene.remove(e[t].object),sceneCubes.splice(n,1),cubesDestroyed+=1,document.getElementById("info").innerText="Cubes destroyed: "+cubesDestroyed}renderer.render(scene,camera)}function onWindowResize(){camera.aspect=videoWidth/videoHeight,camera.updateProjectionMatrix(),renderer.setSize(videoWidth,videoHeight)}console.log("video height",videoHeight),console.log("window height",window.innerHeight),startButton.addEventListener("click",(function(){document.getElementById("overlay").remove(),startVideo(),initLocation(),init(),animate()}),!1);